<!DOCTYPE html>
<html lang="en">

<script src="https://d3js.org/d3.v3.min.js"></script>
<script src="https://d3js.org/d3.v4.min.js"></script>
<script src="https://d3js.org/d3-scale-chromatic.v1.min.js"></script>

<script src="nns_classes.js"></script>
<script src="map_legend.js"></script>

<head>
<meta charset="utf-8">
<link rel="stylesheet" type="text/css" href="nns_style.css">
</head>



<body>

<div class="container" id="title_bar">
  <div class="item" id="thinbar">
    <div class="title">
      Naloxone needed to save
    </div>
  </div>
</div>



<div class="container">
  <div class="item" id="header_links">
    Placeholder for info, links, FAQ, etc section.
  </div>
</div>


<div class="container" id="map_legend_info_container">


  <div class="item flex-column">
    <div class="item"></div>
    <div class="item" id="state_map_legend_box"></div>
    <div class="item"></div>
  </div>

  <div class="item flex-column" id="state_map_column">
    <div id="state_map"></div>
    <div id="selectButtonDiv"><select id="selectButton"></select></div>
  </div>


  <div class="item flex-column" id="state_info_summary">
    <div class="item"></div>
    <div class="item">
      <div id="stats_state_label"></div>
      <div id="state_stats_overview"></div>
    </div>
    <div class="item"></div>
  </div>


</div>


<div class="container plot_section">
  <div class="plot_section_title">
    Deaths averted due to naloxone distribution
  </div>
  <div class="container plot_row">

    <div class="item plot_container" id="plot_1"></div>
    <div class="item plot_container" id="plot_2"></div>
    <div class="item plot_container" id="plot_3"></div>
  </div>
</div>



<div class="container plot_section">
  <div class="plot_section_title">
    Probability of naloxone use during a witnessed overdose
  </div>
  <div class="container plot_row">

    <div class="item plot_container" id="plot_4"></div>
    <div class="item plot_container" id="plot_5"></div>
    <div class="item plot_container" id="plot_6"></div>
  </div>
</div>












<script type="text/javascript">

function stateStatsOverview(data, state){

  if (Object.keys(data).includes(state)) {
    var text = ("<br/>Total deaths: " + data[state]["data_overview"]["yearly_deaths"]);
    text += ("<br/>Fentanyl deaths: " + data[state]["data_overview"]["yearly_fentanyl_deaths"]);
    text += ("<br/>Heroin deaths: " + data[state]["data_overview"]["yearly_heroin_deaths"]);
    text += ("<br/>RX deaths: " + data[state]["data_overview"]["yearly_rx_deaths"]);
    text += ("<br/>THN kits distributed: " + data[state]["data_overview"]["yearly_THN_kits_dist"]);
    text += ("<br/>Naloxone kits used: " + data[state]["data_overview"]["kits_used"]);

    return text;

  }
  else {
    return '';
  }


}





d3.json("all_states.json", function(error, nns_data) {
    // List of groups (here I have one group per column)
    //console.log(nns_data);
    //console.log(Object.keys(nns_data));
    var statesWithData = Object.keys(nns_data);

    var state_selected = statesWithData[0];
    var quick_info_title = "Quick stats: ";
    var state_sel = d3.select("#stats_state_label")
                    .append("text")
                    .text(quick_info_title + state_selected);

    var state_info = d3.select("#state_stats_overview")
                    .append("text")
                    .html(stateStatsOverview(nns_data, state_selected));








// Load GeoJSON data and merge with states data
d3.json("us-states.json", function(geo_json_data) {



// Find the corresponding state inside the GeoJSON
for (var j = 0; j < geo_json_data.features.length; j++)  {
	var geo_json_dataState = geo_json_data.features[j].properties.name;

    if (statesWithData.includes(geo_json_dataState)) {
      var epidemic_type = nns_data[geo_json_dataState]["epidemic_type"];
      var model_nonmodel = nns_data[geo_json_dataState]["model_nonmodel"];
      geo_json_data.features[j].properties.epidemic_type = epidemic_type;
      geo_json_data.features[j].properties.model_nonmodel = model_nonmodel;
    }
    else {
      geo_json_data.features[j].properties.epidemic_type = "Unknown";
      geo_json_data.features[j].properties.model_nonmodel = 'nonmodel';
    }

}



var plot_1 = new PlotNNS("#plot_1", nns_data, "deaths_averted_curve", "THN kits distributed", "Deaths averted", state_selected);
var plot_2 = new PlotNNS("#plot_2", nns_data, "deaths_averted_RX_curve", "RX kits distributed", "Deaths averted", state_selected);
var plot_3 = new PlotNNS("#plot_3", nns_data, "deaths_averted_standing_order_curve", "Standing order kits distributed", "Deaths averted", state_selected);

var plot_4 = new PlotNNS("#plot_4", nns_data, "pNX_vary_THN", "THN kits distributed", "Probability of naloxone use", state_selected);
var plot_5 = new PlotNNS("#plot_5", nns_data, "pNX_vary_RX", "RX kits distributed", "Probability of naloxone use", state_selected);
var plot_6 = new PlotNNS("#plot_6", nns_data, "pNX_vary_standing_order", "Standing order kits distributed", "Probability of naloxone use", state_selected);


//////////////////////////////////
//        UPDATE FUNCTIONS
//////////////////////////////////

function update(selectedGroup) {

  if (statesWithData.includes(selectedGroup)){


    console.log('updating to state: ' + selectedGroup);
    state_selected = selectedGroup;
    state_sel.text(quick_info_title + state_selected);
    state_info.html(stateStatsOverview(nns_data, state_selected));

    d3.select('#selectButton').property('value', state_selected);

    plot_1.updateData(state_selected);
    plot_2.updateData(state_selected);
    plot_3.updateData(state_selected);
    plot_4.updateData(state_selected);
    plot_5.updateData(state_selected);
    plot_6.updateData(state_selected);

  }

}

var map_legend_obj = new MapLegend("#state_map", "#state_map_legend_box", geo_json_data.features, update);


// add the options to the button
d3.select("#selectButton")
  .selectAll('myOptions')
  .data(geo_json_data.features)
  .enter()
  .append('option')
  .text(function (d) { return d.properties.name; }) // text showed in the menu
  .attr("value", function (d) { return d.properties.name; }) // corresponding value returned by the button

d3.select('#selectButton').property('value', state_selected);

// When the button is changed, run the updateChart function
d3.select("#selectButton").on("change", function(d) {
    // recover the option that has been chosen
    var selectedOption = d3.select(this).property("value");
    // run the updateChart function with this selected option
    update(selectedOption);
})



  update(state_selected);


	});//us-states.json


});//all_states.csv


</script>































</body>
</html>
